language: python
dist: trusty
sudo: false
cache: pip
python:
  - 3.6
env:
  - SPLIT=1/20
  - SPLIT=2/20
  - SPLIT=3/20
  - SPLIT=4/20
  - SPLIT=5/20
  - SPLIT=6/20
  - SPLIT=7/20
  - SPLIT=8/20
  - SPLIT=9/20
  - SPLIT=10/20
  - SPLIT=11/20
  - SPLIT=12/20
  - SPLIT=13/20
  - SPLIT=14/20
  - SPLIT=15/20
  - SPLIT=16/20
  - SPLIT=17/20
  - SPLIT=18/20
  - SPLIT=19/20
  - SPLIT=20/20
addons:
  apt:
    packages:
      - libmpc-dev
      - libmpfr-dev
      - libgmp-dev
      - libatlas-dev
      - libatlas-base-dev
      - liblapack-dev
      - gfortran
      - graphviz
matrix:
  include:
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='1/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='2/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='3/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='4/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='5/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='6/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='7/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='8/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='9/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='10/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='11/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='12/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='13/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='14/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='15/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='16/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='17/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='18/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='19/20'
    - python: 3.4
      env: COVERAGE='on' SELECT='not slow and not xfail' SPLIT='20/20'
    - python: 3.5
      env: COVERAGE='on' EXTRA='on'
      install:
        - travis_wait pip install .[exports,plot,interactive,develop,docs]
      script:
        - python setup.py flake8
        - sphinx-build -W -b html docs build/sphinx/html
        - py.test --cov diofant diofant/polys
    - python: 3.5
      env: COVERAGE='on' EXTRA='on' DIOFANT_GROUND_TYPES='gmpy'
      install:
        - travis_wait pip install .[exports,develop]
      script:
        - py.test --cov diofant diofant/domains
before_install:
  - pip install --upgrade pip setuptools pytest codecov
install:
  - travis_wait pip install .[exports,plot,interactive,gmpy]
before_script:
  - sh -e /etc/init.d/xvfb start
  - export DISPLAY=:99.0
script:
  - |
    if [ -n "${COVERAGE}" ]; then
      python setup.py test --addopts "--cov diofant -m \"${SELECT}\" --split=${SPLIT}"
    else
      python setup.py test --addopts "--split=${SPLIT}"
    fi
after_success: test -n "${COVERAGE}" && codecov
deploy:
  provider: pypi
  user: skirpichev
  password:
    secure: "OCi5YeQKvjr62Yzg1Bq9/xzIVDJSlr3q3YICp/gfnoPxTmiOiOug/QSM0rxl929Rb9hvf/QuNI6bpkPs0lz2roXa0PdJ2pdoNOm5Md2e43htbMRfH54YS98QDxL+gwasr327iGLi++avxF3N+vSyWboJLkSydDDlVhB7k/t57Ig="
  distributions: "sdist bdist_wheel"
  server: https://pypi.python.org/pypi
  on:
    python: 3.4
    condition: -z "${COVERAGE}" && "${SPLIT}" = "1/20" && "${TRAVIS_EVENT_TYPE}" != "cron"
    tags: true
notifications:
  email: false
